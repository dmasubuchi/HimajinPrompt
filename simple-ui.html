<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ã²ã¾ã˜ã‚“å¼BPMN - ã‚·ãƒ³ãƒ—ãƒ«å…¥åŠ›ç”»é¢</title>
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 40px;
      font-size: 14px;
    }

    .section {
      margin-bottom: 30px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
      font-size: 14px;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
      box-sizing: border-box;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }

    .help-text {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }

    .button-group {
      display: flex;
      gap: 20px;
      margin-top: 40px;
    }

    button {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-generate {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-generate:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .btn-clear {
      background: #f5f5f5;
      color: #666;
    }

    .btn-clear:hover {
      background: #e0e0e0;
    }

    .result {
      margin-top: 30px;
      padding: 20px;
      background: #f0f7ff;
      border-radius: 10px;
      display: none;
    }

    .result.show {
      display: block;
    }

    .result h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .result-content {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .url-display {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 5px;
      margin-top: 10px;
    }

    .url-display a {
      color: #667eea;
      text-decoration: none;
      word-break: break-all;
    }

    .url-display a:hover {
      text-decoration: underline;
    }

    .json-display {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      white-space: pre;
      max-height: 400px;
      overflow-y: auto;
    }

    .copy-button {
      background: #667eea;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      margin-top: 10px;
    }

    .copy-button:hover {
      background: #5a67d8;
    }

    .loading {
      text-align: center;
      color: #667eea;
      display: none;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .example-link {
      text-align: center;
      margin-bottom: 20px;
    }

    .example-link a {
      color: #667eea;
      text-decoration: none;
      font-size: 14px;
    }

    .example-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¯ ã²ã¾ã˜ã‚“å¼BPMNç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </h1>
    <p class="subtitle">æ¥­å‹™ãƒ•ãƒ­ãƒ¼ã‚’ç°¡å˜å…¥åŠ› â†’ è‡ªå‹•ã§ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆ</p>

    <div class="example-link">
      <a href="#" onclick="loadExample(); return false;">ğŸ“ ã‚µãƒ³ãƒ—ãƒ«ã‚’å…¥åŠ›</a>
    </div>

    <form id="bpmnForm">
      <div class="section">
        <label for="processName">ãƒ—ãƒ­ã‚»ã‚¹å *</label>
        <input type="text" id="processName" placeholder="ä¾‹ï¼šå—æ³¨å‡¦ç†ãƒ•ãƒ­ãƒ¼" required>
      </div>

      <div class="section">
        <label for="actors">é–¢ä¿‚è€…ï¼ˆéƒ¨é–€ãƒ»æ‹…å½“è€…ï¼‰*</label>
        <textarea id="actors" placeholder="1è¡Œã«1ã¤ãšã¤å…¥åŠ›ã—ã¦ãã ã•ã„&#10;ä¾‹ï¼š&#10;å–¶æ¥­éƒ¨&#10;å€‰åº«&#10;è³¼è²·éƒ¨" required></textarea>
        <p class="help-text">å„è¡Œã«éƒ¨é–€åã‚„æ‹…å½“è€…åã‚’è¨˜å…¥</p>
      </div>

      <div class="section">
        <label for="flow">æ¥­å‹™ã®æµã‚Œ *</label>
        <textarea id="flow" placeholder="èª°ãŒä½•ã‚’ã™ã‚‹ã‹æ›¸ã„ã¦ãã ã•ã„&#10;ä¾‹ï¼š&#10;1. å–¶æ¥­éƒ¨ãŒæ³¨æ–‡ã‚’å—ä»˜&#10;2. å€‰åº«ãŒåœ¨åº«ã‚’ç¢ºèª&#10;3. åœ¨åº«ãŒã‚ã‚Œã°å‡ºè·å‡¦ç†&#10;4. åœ¨åº«ãŒãªã‘ã‚Œã°è³¼è²·éƒ¨ã«ç™ºæ³¨ä¾é ¼" required></textarea>
        <p class="help-text">ç•ªå·ä»˜ãã§é †ç•ªã«è¨˜å…¥ã™ã‚‹ã¨åˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™</p>
      </div>

      <div class="section">
        <label for="decisions">åˆ¤æ–­ãƒ»åˆ†å²ãƒã‚¤ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰</label>
        <textarea id="decisions" placeholder="ä¾‹ï¼š&#10;åœ¨åº«ã®æœ‰ç„¡&#10;é‡‘é¡ã«ã‚ˆã‚‹æ‰¿èª&#10;ä¸ä¿¡ãƒã‚§ãƒƒã‚¯"></textarea>
        <p class="help-text">æ¡ä»¶åˆ†å²ãŒã‚ã‚‹å ´åˆã¯è¨˜å…¥</p>
      </div>

      <div class="section">
        <label for="orientation">ã‚¹ãƒ©ã‚¤ãƒ‰ã®å‘ã</label>
        <select id="orientation">
          <option value="both">ä¸¡æ–¹ï¼ˆæ¨ªå‹ãƒ»ç¸¦å‹ï¼‰</option>
          <option value="horizontal">æ¨ªå‹ã®ã¿</option>
          <option value="vertical">ç¸¦å‹ã®ã¿</option>
        </select>
      </div>

      <div class="button-group">
        <button type="button" class="btn-clear" onclick="clearForm()">ã‚¯ãƒªã‚¢</button>
        <button type="submit" class="btn-generate">ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆ</button>
      </div>
    </form>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>ç”Ÿæˆä¸­...</p>
    </div>

    <div class="result" id="result">
      <h3>âœ… ç”Ÿæˆå®Œäº†ï¼</h3>
      <div class="result-content">
        <p><strong>ã‚¹ãƒ©ã‚¤ãƒ‰URLï¼š</strong></p>
        <div class="url-display">
          <a id="slideUrl" href="#" target="_blank">ç”Ÿæˆã•ã‚ŒãŸã‚¹ãƒ©ã‚¤ãƒ‰ã‚’é–‹ã</a>
        </div>

        <p style="margin-top: 20px;"><strong>ç”Ÿæˆã•ã‚ŒãŸJSONï¼š</strong></p>
        <div class="json-display" id="jsonDisplay"></div>
        <button class="copy-button" onclick="copyJSON()">JSONã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
  </div>

  <script>
    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
    document.getElementById('bpmnForm').addEventListener('submit', function(e) {
      e.preventDefault();
      generateBPMN();
    });

    function generateBPMN() {
      // Loadingè¡¨ç¤º
      document.getElementById('loading').classList.add('show');
      document.getElementById('result').classList.remove('show');

      // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å–å¾—
      const processName = document.getElementById('processName').value;
      const actors = document.getElementById('actors').value.split('\n').filter(a => a.trim());
      const flow = document.getElementById('flow').value;
      const decisions = document.getElementById('decisions').value;
      const orientation = document.getElementById('orientation').value;

      // JSONç”Ÿæˆ
      const jsonData = createJSON(processName, actors, flow, decisions, orientation);

      // Google Apps Scriptã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—
      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onFailure)
        .generateBPMNPresentationFromWeb(jsonData);
    }

    function createJSON(processName, actors, flow, decisions, orientation) {
      // ã‚¢ã‚¯ã‚¿ãƒ¼ç”Ÿæˆ
      const actorList = actors.map((name, index) => ({
        id: `A${index + 1}`,
        name: name.trim(),
        type: 'department'
      }));

      // ã‚¿ã‚¹ã‚¯ç”Ÿæˆï¼ˆç°¡æ˜“ãƒ‘ãƒ¼ã‚¹ï¼‰
      const tasks = [];
      const flows = [];
      const lines = flow.split('\n');

      lines.forEach((line, index) => {
        const cleanLine = line.replace(/^\d+\.\s*/, '').trim();
        if (cleanLine) {
          // "XXãŒâ—‹â—‹ã™ã‚‹"ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
          const match = cleanLine.match(/(.+?)[ãŒã¯](.+)/);
          if (match) {
            const actorName = match[1].trim();
            const taskName = match[2].trim();

            // ã‚¢ã‚¯ã‚¿ãƒ¼ã‚’ç‰¹å®š
            const actor = actorList.find(a => a.name.includes(actorName) || actorName.includes(a.name));

            const taskId = `T${index + 1}`;
            tasks.push({
              id: taskId,
              name: taskName,
              actor: actor ? actor.id : 'A1',
              type: 'userTask'
            });

            // ãƒ•ãƒ­ãƒ¼è¿½åŠ 
            if (index > 0) {
              flows.push({
                from: `T${index}`,
                to: taskId
              });
            }
          }
        }
      });

      // ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ç”Ÿæˆ
      const gateways = [];
      if (decisions) {
        const decisionLines = decisions.split('\n').filter(d => d.trim());
        decisionLines.forEach((decision, index) => {
          gateways.push({
            id: `G${index + 1}`,
            name: decision.trim(),
            type: 'exclusive'
          });
        });
      }

      return {
        processInfo: {
          name: processName,
          version: '1.0',
          generatedAt: new Date().toISOString()
        },
        orientation: orientation,
        actors: actorList,
        tasks: tasks,
        gateways: gateways,
        flows: flows
      };
    }

    function onSuccess(result) {
      document.getElementById('loading').classList.remove('show');

      if (result.success) {
        document.getElementById('slideUrl').href = result.url;
        document.getElementById('slideUrl').textContent = result.url;
        document.getElementById('jsonDisplay').textContent = JSON.stringify(result.jsonData || {}, null, 2);
        document.getElementById('result').classList.add('show');
      } else {
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
      }
    }

    function onFailure(error) {
      document.getElementById('loading').classList.remove('show');
      alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
    }

    function clearForm() {
      if (confirm('å…¥åŠ›å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
        document.getElementById('bpmnForm').reset();
        document.getElementById('result').classList.remove('show');
      }
    }

    function copyJSON() {
      const jsonText = document.getElementById('jsonDisplay').textContent;
      navigator.clipboard.writeText(jsonText).then(() => {
        alert('JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      });
    }

    function loadExample() {
      document.getElementById('processName').value = 'å—æ³¨å‡¦ç†ãƒ•ãƒ­ãƒ¼';
      document.getElementById('actors').value = 'å–¶æ¥­éƒ¨\nå€‰åº«\nè³¼è²·éƒ¨\nçµŒç†éƒ¨';
      document.getElementById('flow').value = '1. å–¶æ¥­éƒ¨ãŒæ³¨æ–‡ã‚’å—ä»˜\n2. å–¶æ¥­éƒ¨ãŒä¸ä¿¡ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿæ–½\n3. å€‰åº«ãŒåœ¨åº«ã‚’ç¢ºèª\n4. åœ¨åº«ãŒã‚ã‚Œã°å€‰åº«ãŒå‡ºè·å‡¦ç†\n5. åœ¨åº«ãŒãªã‘ã‚Œã°è³¼è²·éƒ¨ã«ç™ºæ³¨ä¾é ¼\n6. çµŒç†éƒ¨ãŒè«‹æ±‚æ›¸ã‚’ç™ºè¡Œ';
      document.getElementById('decisions').value = 'åœ¨åº«ã®æœ‰ç„¡\nä¸ä¿¡OK/NG\né‡‘é¡ã«ã‚ˆã‚‹æ‰¿èª';
      document.getElementById('orientation').value = 'both';
    }
  </script>
</body>
</html>