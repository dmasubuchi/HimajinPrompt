<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ひまじん式BPMN - シンプル入力画面</title>
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 40px;
      font-size: 14px;
    }

    .section {
      margin-bottom: 30px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
      font-size: 14px;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
      box-sizing: border-box;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }

    .help-text {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }

    .button-group {
      display: flex;
      gap: 20px;
      margin-top: 40px;
    }

    button {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-generate {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-generate:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .btn-clear {
      background: #f5f5f5;
      color: #666;
    }

    .btn-clear:hover {
      background: #e0e0e0;
    }

    .result {
      margin-top: 30px;
      padding: 20px;
      background: #f0f7ff;
      border-radius: 10px;
      display: none;
    }

    .result.show {
      display: block;
    }

    .result h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .result-content {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .url-display {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 5px;
      margin-top: 10px;
    }

    .url-display a {
      color: #667eea;
      text-decoration: none;
      word-break: break-all;
    }

    .url-display a:hover {
      text-decoration: underline;
    }

    .json-display {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      white-space: pre;
      max-height: 400px;
      overflow-y: auto;
    }

    .copy-button {
      background: #667eea;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      margin-top: 10px;
    }

    .copy-button:hover {
      background: #5a67d8;
    }

    .loading {
      text-align: center;
      color: #667eea;
      display: none;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .example-link {
      text-align: center;
      margin-bottom: 20px;
    }

    .example-link a {
      color: #667eea;
      text-decoration: none;
      font-size: 14px;
    }

    .example-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎯 ひまじん式BPMN生成システム</h1>
    <p class="subtitle">業務フローを簡単入力 → 自動でスライド生成</p>

    <div class="example-link">
      <a href="#" onclick="loadExample(); return false;">📝 サンプルを入力</a>
    </div>

    <form id="bpmnForm">
      <div class="section">
        <label for="processName">プロセス名 *</label>
        <input type="text" id="processName" placeholder="例：受注処理フロー" required>
      </div>

      <div class="section">
        <label for="actors">関係者（部門・担当者）*</label>
        <textarea id="actors" placeholder="1行に1つずつ入力してください&#10;例：&#10;営業部&#10;倉庫&#10;購買部" required></textarea>
        <p class="help-text">各行に部門名や担当者名を記入</p>
      </div>

      <div class="section">
        <label for="flow">業務の流れ *</label>
        <textarea id="flow" placeholder="誰が何をするか書いてください&#10;例：&#10;1. 営業部が注文を受付&#10;2. 倉庫が在庫を確認&#10;3. 在庫があれば出荷処理&#10;4. 在庫がなければ購買部に発注依頼" required></textarea>
        <p class="help-text">番号付きで順番に記入すると分かりやすいです</p>
      </div>

      <div class="section">
        <label for="decisions">判断・分岐ポイント（任意）</label>
        <textarea id="decisions" placeholder="例：&#10;在庫の有無&#10;金額による承認&#10;与信チェック"></textarea>
        <p class="help-text">条件分岐がある場合は記入</p>
      </div>

      <div class="section">
        <label for="orientation">スライドの向き</label>
        <select id="orientation">
          <option value="both">両方（横型・縦型）</option>
          <option value="horizontal">横型のみ</option>
          <option value="vertical">縦型のみ</option>
        </select>
      </div>

      <div class="button-group">
        <button type="button" class="btn-clear" onclick="clearForm()">クリア</button>
        <button type="submit" class="btn-generate">スライド生成</button>
      </div>
    </form>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>生成中...</p>
    </div>

    <div class="result" id="result">
      <h3>✅ 生成完了！</h3>
      <div class="result-content">
        <p><strong>スライドURL：</strong></p>
        <div class="url-display">
          <a id="slideUrl" href="#" target="_blank">生成されたスライドを開く</a>
        </div>

        <p style="margin-top: 20px;"><strong>生成されたJSON：</strong></p>
        <div class="json-display" id="jsonDisplay"></div>
        <button class="copy-button" onclick="copyJSON()">JSONをコピー</button>
      </div>
    </div>
  </div>

  <script>
    // フォーム送信処理
    document.getElementById('bpmnForm').addEventListener('submit', function(e) {
      e.preventDefault();
      generateBPMN();
    });

    function generateBPMN() {
      // Loading表示
      document.getElementById('loading').classList.add('show');
      document.getElementById('result').classList.remove('show');

      // フォームデータ取得
      const processName = document.getElementById('processName').value;
      const actors = document.getElementById('actors').value.split('\n').filter(a => a.trim());
      const flow = document.getElementById('flow').value;
      const decisions = document.getElementById('decisions').value;
      const orientation = document.getElementById('orientation').value;

      // JSON生成
      const jsonData = createJSON(processName, actors, flow, decisions, orientation);

      // Google Apps Scriptの関数を呼び出し
      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onFailure)
        .generateBPMNPresentationFromWeb(jsonData);
    }

    function createJSON(processName, actors, flow, decisions, orientation) {
      // アクター生成
      const actorList = actors.map((name, index) => ({
        id: `A${index + 1}`,
        name: name.trim(),
        type: 'department'
      }));

      // タスク生成（簡易パース）
      const tasks = [];
      const flows = [];
      const lines = flow.split('\n');

      lines.forEach((line, index) => {
        const cleanLine = line.replace(/^\d+\.\s*/, '').trim();
        if (cleanLine) {
          // "XXが○○する"パターンを検出
          const match = cleanLine.match(/(.+?)[がは](.+)/);
          if (match) {
            const actorName = match[1].trim();
            const taskName = match[2].trim();

            // アクターを特定
            const actor = actorList.find(a => a.name.includes(actorName) || actorName.includes(a.name));

            const taskId = `T${index + 1}`;
            tasks.push({
              id: taskId,
              name: taskName,
              actor: actor ? actor.id : 'A1',
              type: 'userTask'
            });

            // フロー追加
            if (index > 0) {
              flows.push({
                from: `T${index}`,
                to: taskId
              });
            }
          }
        }
      });

      // ゲートウェイ生成
      const gateways = [];
      if (decisions) {
        const decisionLines = decisions.split('\n').filter(d => d.trim());
        decisionLines.forEach((decision, index) => {
          gateways.push({
            id: `G${index + 1}`,
            name: decision.trim(),
            type: 'exclusive'
          });
        });
      }

      return {
        processInfo: {
          name: processName,
          version: '1.0',
          generatedAt: new Date().toISOString()
        },
        orientation: orientation,
        actors: actorList,
        tasks: tasks,
        gateways: gateways,
        flows: flows
      };
    }

    function onSuccess(result) {
      document.getElementById('loading').classList.remove('show');

      if (result.success) {
        document.getElementById('slideUrl').href = result.url;
        document.getElementById('slideUrl').textContent = result.url;
        document.getElementById('jsonDisplay').textContent = JSON.stringify(result.jsonData || {}, null, 2);
        document.getElementById('result').classList.add('show');
      } else {
        alert('エラーが発生しました: ' + (result.error || '不明なエラー'));
      }
    }

    function onFailure(error) {
      document.getElementById('loading').classList.remove('show');
      alert('エラーが発生しました: ' + error);
    }

    function clearForm() {
      if (confirm('入力内容をクリアしますか？')) {
        document.getElementById('bpmnForm').reset();
        document.getElementById('result').classList.remove('show');
      }
    }

    function copyJSON() {
      const jsonText = document.getElementById('jsonDisplay').textContent;
      navigator.clipboard.writeText(jsonText).then(() => {
        alert('JSONをコピーしました');
      });
    }

    function loadExample() {
      document.getElementById('processName').value = '受注処理フロー';
      document.getElementById('actors').value = '営業部\n倉庫\n購買部\n経理部';
      document.getElementById('flow').value = '1. 営業部が注文を受付\n2. 営業部が与信チェックを実施\n3. 倉庫が在庫を確認\n4. 在庫があれば倉庫が出荷処理\n5. 在庫がなければ購買部に発注依頼\n6. 経理部が請求書を発行';
      document.getElementById('decisions').value = '在庫の有無\n与信OK/NG\n金額による承認';
      document.getElementById('orientation').value = 'both';
    }
  </script>
</body>
</html>